<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    .tab-button {
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    .tab-button:hover {
      background-color: #0056b3;
    }

    .tab-content {
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    .error {
      color: red;
    }
  </style>
</head>
<body>
<button class="tab-button" data-tab="auth">Авторизація</button>
<button class="tab-button" data-tab="users">Користувачі</button>
<button class="tab-button" data-tab="weather">Погода</button>

<div id="auth" class="tab-content">
  <h2>Авторизація</h2>
  <form id="authForm">
    <label for="email">Email:</label><br>
    <input type="email" id="email" name="email"><br>
    <span id="emailError" class="error"></span><br><br>

    <label for="password">Пароль:</label><br>
    <input type="password" id="password" name="password"><br>
    <span id="passwordError" class="error"></span><br><br>

    <button type="submit">Увійти</button>
  </form>
  <button id="logoutButton" style="display: none;">Вийти</button>
  <p id="welcomeMessage" style="display: none;"></p>
</div>

<div id="users" class="tab-content" style="display: none;">
  <h2>Користувачі</h2>
  <input type="text" id="filterInput" placeholder="Фільтрувати за іменем">
  <button id="sortButton">Сортувати</button>
  <table id="usersTable">
    <thead>
    <tr>
      <th>ID</th>
      <th>Email</th>
      <th>Ім'я</th>
      <th>Прізвище</th>
      <th>Температура</th>
      <th>Погодні умови</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="weather" class="tab-content" style="display: none;">
  <h2>Погода</h2>
  <p id="weatherData"></p>
</div>
<script>
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  const authForm = document.getElementById('authForm');
  const logoutButton = document.getElementById('logoutButton');
  const welcomeMessage = document.getElementById('welcomeMessage');
  const usersTable = document.getElementById('usersTable').querySelector('tbody');
  const weatherData = document.getElementById('weatherData');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const emailError = document.getElementById('emailError');
  const passwordError = document.getElementById('passwordError');
  const filterInput = document.getElementById('filterInput');
  const sortButton = document.getElementById('sortButton');

  let token = sessionStorage.getItem('token');
  let usersCache = JSON.parse(localStorage.getItem('usersCache')) || { data: [], timestamp: 0 };

  function showTab(tabId) {
    tabContents.forEach(content => {
      content.style.display = content.id === tabId ? 'block' : 'none';
    });
  }


  function displayUsers(users, weatherData) {
    usersTable.innerHTML = '';
    users.forEach(user => {
      const row = usersTable.insertRow();
      row.insertCell().textContent = user.id;
      row.insertCell().textContent = user.email;
      row.insertCell().textContent = user.first_name;
      row.insertCell().textContent = user.last_name;
      row.insertCell().textContent = weatherData ? weatherData.current_weather.temperature : 'N/A';
      row.insertCell().textContent = weatherData ? weatherData.current_weather.weathercode : 'N/A';
    });
  }



  async function fetchUsersAndWeather() {
    const now = Date.now();
    if (usersCache.data.length > 0 && now - usersCache.timestamp < 3600000) {
      displayUsers(usersCache.data);
      return;
    }

    try {
      const usersResponse = await fetch('https://reqres.in/api/users');
      const usersData = await usersResponse.json();

      const weatherResponse = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35&longitude=139&daily=weather_code&hourly=temperature_2m,weather_code&current=temperature_2m&timezone=Europe%2FBerlin');
      const weatherJson = await weatherResponse.json();

      usersCache = { data: usersData.data, timestamp: now };
      localStorage.setItem('usersCache', JSON.stringify(usersCache));

      displayUsers(usersData.data, weatherJson);
    } catch (error) {
      console.log('Помилка отримання даних:', error);
      alert('Помилка отримання даних');
    }
  }


  function checkToken() {
    if (!token) {
      showTab('auth');
    } else {
      showTab('users');
      fetchUsersAndWeather();

      logoutButton.style.display = 'block';
    }
  }



  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      const tabId = this.dataset.tab;
      showTab(tabId);
      if (tabId === 'users' && token) {
        fetchUsersAndWeather();
      } else if (tabId === 'auth' && token) {
        checkToken();
      }
    });
  });





  authForm.addEventListener('submit', async function(event) {
    event.preventDefault();

    const email = emailInput.value;
    const password = passwordInput.value;

    emailError.textContent = '';
    passwordError.textContent = '';

    let isValid = true;

    if (email === '') {
      emailError.textContent = 'Поле email не може бути порожнім';
      isValid = false;
    }

    if (password === '') {
      passwordError.textContent = 'Поле пароль не може бути порожнім';
      isValid = false;
    }

    if (!isValid) {
      return;
    }

    try {
      const response = await fetch('https://reqres.in/api/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ email, password })
      });

      if (response.ok) {
        const data = await response.json();
        token = data.token;
        sessionStorage.setItem('token', token);
        checkToken();
      } else {
        alert('Неправильний email або пароль');
      }
    } catch (error) {
      console.log('Помилка авторизації:', error);
      alert('Помилка авторизації');
    }
  });

  logoutButton.addEventListener('click', function() {
    sessionStorage.removeItem('token');
    token = null;

    logoutButton.style.display = 'none';
    showTab('auth');
  });



  filterInput.addEventListener('input', function() {
    const filterValue = this.value.toLowerCase();
    const filteredUsers = usersCache.data.filter(user =>
            user.first_name.toLowerCase().includes(filterValue) || user.last_name.toLowerCase().includes(filterValue));
    displayUsers(filteredUsers, weatherData);
  });

  sortButton.addEventListener('click', function() {
    const sortedUsers = [...usersCache.data].sort((a, b) => a.first_name.localeCompare(b.first_name));
    displayUsers(sortedUsers, weatherData);
  });

  checkToken();
</script>
</body>
</html>